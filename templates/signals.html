<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Trading Signals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-buy {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
        }
        @keyframes pulse-sell {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }
        .signal-buy { animation: pulse-buy 1.5s infinite; }
        .signal-sell { animation: pulse-sell 1.5s infinite; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">âš¡ Real-Time Trading Signals</h1>
                    <p class="text-purple-200 mt-1">Live Order Flow & Entry/Exit Analysis</p>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                        ðŸ“Š Big Move Dashboard
                    </a>
                    <div class="flex items-center gap-2">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span id="status-text" class="text-sm">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Active Signals Banner -->
        <div id="active-signals-banner" class="hidden mb-8 p-6 rounded-lg border-2 animate-pulse">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-2xl font-bold" id="signal-action">WAITING FOR SIGNALS</div>
                    <div class="text-sm mt-1" id="signal-details">No active signals</div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Confidence</div>
                    <div class="text-3xl font-bold" id="signal-confidence">-</div>
                </div>
            </div>
        </div>

        <!-- Instruments Grid -->
        <div id="instruments-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6 text-center text-gray-500">
                Waiting for market data...
            </div>
        </div>

        <!-- Signal History -->
        <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-bold">ðŸ“œ Signal History</h2>
                <button onclick="clearHistory()" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                    Clear
                </button>
            </div>
            <div id="signal-history" class="p-6 max-h-96 overflow-y-auto">
                <div class="text-gray-500">No signals yet</div>
            </div>
        </div>
    </main>

    <script>
        let eventSource = null;
        let instrumentData = new Map();
        let signalHistory = [];

        // Safe number conversion with defaults
        function toNum(val, defaultVal = 0) {
            if (val === null || val === undefined || val === '') return defaultVal;
            const num = Number(val);
            return isNaN(num) ? defaultVal : num;
        }

        // Safe string getter
        function getStr(obj, key, defaultVal = 'UNKNOWN') {
            return obj && obj[key] ? String(obj[key]) : defaultVal;
        }

        // Initialize SSE
        function initSSE() {
            eventSource = new EventSource('/stream/signals');
            
            eventSource.onopen = () => {
                updateStatus('connected');
                console.log('âœ… Connected to Signals Stream');
            };
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'connection') {
                        console.log('âœ… Connected:', data.message);
                        return;
                    }
                    
                    if (data.type === 'signal_update' && data.analyses) {
                        handleSignalUpdate(data);
                    }
                } catch (error) {
                    console.error('Parse error:', error);
                }
            };
            
            eventSource.onerror = () => {
                updateStatus('disconnected');
                setTimeout(initSSE, 5000);
            };
        }

        // Handle signal updates
        function handleSignalUpdate(data) {
            if (!data.analyses || typeof data.analyses !== 'object') {
                return;
            }
            
            Object.entries(data.analyses).forEach(([symbol, analysis]) => {
                if (!analysis || !analysis.indicators) {
                    return;
                }
                
                instrumentData.set(symbol, analysis);
                
                // Check for new signals
                if (analysis.signals) {
                    if (analysis.signals.buy) {
                        showActiveBuySignal(analysis.signals.buy);
                        addToHistory(analysis.signals.buy);
                    }
                    if (analysis.signals.sell) {
                        showActiveSellSignal(analysis.signals.sell);
                        addToHistory(analysis.signals.sell);
                    }
                }
            });
            
            renderInstruments();
        }

        // Show active buy signal
        function showActiveBuySignal(signal) {
            const banner = document.getElementById('active-signals-banner');
            const isStrongSignal = signal.action === 'STRONG_BUY';
            
            banner.className = `mb-8 p-6 rounded-lg border-2 ${isStrongSignal ? 'border-green-400' : 'border-green-500'} bg-green-900 bg-opacity-20 signal-buy`;
            banner.classList.remove('hidden');
            
            const symbol = signal.symbol || 'Unknown';
            const entry = toNum(signal.entry, 0);
            const signalCount = toNum(signal.signal_count, 0);
            const totalConditions = toNum(signal.total_conditions, 7);
            const confidence = toNum(signal.confidence, 0);
            const alert = signal.alert || '';
            
            document.getElementById('signal-action').innerHTML = 
                `${isStrongSignal ? 'ðŸ”¥ STRONG BUY SIGNAL ðŸ”¥' : 'ðŸŸ¢ BUY SIGNAL'}${alert ? '<br><span class="text-yellow-400 text-base">' + alert + '</span>' : ''}`;
            document.getElementById('signal-details').textContent = 
                `${symbol.split('|')[1] || symbol} @ â‚¹${entry.toFixed(2)} | ${signalCount}/${totalConditions} conditions met`;
            document.getElementById('signal-confidence').textContent = 
                `${(confidence * 100).toFixed(0)}%`;
            
            setTimeout(() => banner.classList.add('hidden'), isStrongSignal ? 15000 : 10000);
        }

        // Show active sell signal
        function showActiveSellSignal(signal) {
            const banner = document.getElementById('active-signals-banner');
            banner.className = 'mb-8 p-6 rounded-lg border-2 border-red-500 bg-red-900 bg-opacity-20 signal-sell';
            banner.classList.remove('hidden');
            
            const symbol = signal.symbol || 'Unknown';
            const exit = toNum(signal.exit, 0);
            const reason = signal.reason || 'Unknown';
            const signalCount = toNum(signal.signal_count, 0);
            
            document.getElementById('signal-action').textContent = 'ðŸ”´ SELL SIGNAL';
            document.getElementById('signal-details').textContent = 
                `${symbol.split('|')[1] || symbol} @ â‚¹${exit.toFixed(2)} | ${reason}`;
            document.getElementById('signal-confidence').textContent = `${signalCount}/5`;
            
            setTimeout(() => banner.classList.add('hidden'), 10000);
        }

        // Add to history
        function addToHistory(signal) {
            signalHistory.unshift({
                ...signal,
                time: new Date().toLocaleTimeString()
            });
            
            if (signalHistory.length > 20) {
                signalHistory.pop();
            }
            
            renderHistory();
        }

        // Render instruments
        function renderInstruments() {
            const grid = document.getElementById('instruments-grid');
            
            if (instrumentData.size === 0) {
                grid.innerHTML = '<div class="bg-gray-800 rounded-lg p-6 text-center text-gray-500">Waiting for market data...</div>';
                return;
            }
            
            grid.innerHTML = '';
            
            instrumentData.forEach((analysis, symbol) => {
                const card = createInstrumentCard(symbol, analysis);
                grid.innerHTML += card;
            });
        }

        // Create instrument card
        function createInstrumentCard(symbol, analysis) {
            if (!analysis || !analysis.indicators) {
                return `<div class="bg-gray-800 rounded-lg p-6 text-red-400">Error: Invalid data for ${symbol}</div>`;
            }
            
            const indicators = analysis.indicators;
            const ltp = toNum(analysis.ltp, 0);
            
            // OFI with safe defaults
            const ofi = indicators.ofi || {};
            const ofiValue = toNum(ofi.value, 0);
            const ofiSignal = getStr(ofi, 'signal', 'NEUTRAL');
            const ofiTbq = toNum(ofi.tbq, 0);
            const ofiTsq = toNum(ofi.tsq, 0);
            
            // Spread with safe defaults - check if spread data exists
            const spread = indicators.spread || {};
            const hasSpreadData = spread.percentage !== undefined && spread.percentage !== null;
            const spreadPct = hasSpreadData ? toNum(spread.percentage, 0) : 0;
            const spreadSignal = hasSpreadData ? getStr(spread, 'signal', 'UNKNOWN') : 'NO DATA';
            const spreadBid = toNum(spread.best_bid, ltp);
            const spreadAsk = toNum(spread.best_ask, ltp);
            const spreadQuality = toNum(spread.quality, 0);
            
            // Momentum with safe defaults
            const momentum = indicators.momentum || {};
            const momentumValue = toNum(momentum.value, 0);
            const momentumSignal = getStr(momentum, 'signal', 'NEUTRAL');
            const momentumAvg = toNum(momentum.avg, 0);
            const momentumTicks = toNum(momentum.ticks, 0);
            
            // Volume spike with safe defaults
            const volumeSpike = indicators.volume_spike || {};
            const volRatio = toNum(volumeSpike.ratio, 0);
            const volSignal = getStr(volumeSpike, 'signal', 'NORMAL');
            const volCurrent = toNum(volumeSpike.current, 0);
            const volAvg = toNum(volumeSpike.avg, 0);
            
            // Colors
            const ofiColor = ofiValue > 0.5 ? 'text-green-400' : 
                            ofiValue > 0.3 ? 'text-blue-400' : 
                            ofiValue < 0 ? 'text-red-400' : 'text-gray-400';
            
            const spreadColor = spreadPct < 0.2 ? 'text-green-400' : 
                               spreadPct < 0.5 ? 'text-yellow-400' : 'text-red-400';
            
            const momentumColor = momentumSignal === 'BULLISH' ? 'text-green-400' : 
                                 momentumSignal === 'BEARISH' ? 'text-red-400' : 'text-gray-400';
            
            const volumeColor = volRatio >= 3 ? 'text-red-400' : 
                               volRatio >= 2 ? 'text-yellow-400' : 'text-gray-400';
            
            return `
                <div class="bg-gray-800 rounded-lg p-6 shadow-xl border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-2xl font-bold">${symbol.split('|')[1] || symbol}</h3>
                            <p class="text-gray-400 text-sm">${symbol}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">â‚¹${ltp.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- Indicators Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <!-- OFI -->
                        <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                            <div class="text-xs text-gray-400 mb-2">Order Flow Imbalance</div>
                            <div class="${ofiColor} text-2xl font-bold mb-1">${ofiValue.toFixed(3)}</div>
                            <div class="text-sm font-semibold ${ofiColor}">${ofiSignal}</div>
                            <div class="mt-2 text-xs text-gray-500">
                                Bid: ${ofiTbq.toLocaleString()} | Ask: ${ofiTsq.toLocaleString()}
                            </div>
                            <div class="mt-2 w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-red-500 via-gray-500 to-green-500 h-2 rounded-full transition-all"
                                     style="width: ${((ofiValue + 1) / 2 * 100).toFixed(0)}%"></div>
                            </div>
                        </div>
                        
                        <!-- Spread Quality -->
                        <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                            <div class="text-xs text-gray-400 mb-2">Spread Quality</div>
                            <div class="${spreadColor} text-2xl font-bold mb-1">${spreadPct.toFixed(2)}%</div>
                            <div class="text-sm font-semibold ${spreadColor}">${spreadSignal}</div>
                            <div class="mt-2 text-xs text-gray-500">
                                ${spreadBid.toFixed(2)} â†” ${spreadAsk.toFixed(2)}
                            </div>
                            <div class="mt-2">
                                <div class="text-xs text-gray-400">Quality: ${spreadQuality.toFixed(0)}%</div>
                                <div class="w-full bg-gray-700 rounded-full h-2 mt-1">
                                    <div class="${spreadColor.replace('text', 'bg')} h-2 rounded-full transition-all"
                                         style="width: ${spreadQuality}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Momentum -->
                        <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                            <div class="text-xs text-gray-400 mb-2">Price Momentum</div>
                            <div class="${momentumColor} text-2xl font-bold mb-1">${(momentumValue * 100).toFixed(2)}%</div>
                            <div class="text-sm font-semibold ${momentumColor}">${momentumSignal}</div>
                            <div class="mt-2 text-xs text-gray-500">
                                Avg: ${momentumAvg.toFixed(2)} (${momentumTicks} ticks)
                            </div>
                        </div>
                        
                        <!-- Volume Spike -->
                        <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                            <div class="text-xs text-gray-400 mb-2">Volume Spike</div>
                            <div class="${volumeColor} text-2xl font-bold mb-1">${volRatio.toFixed(1)}x</div>
                            <div class="text-sm font-semibold ${volumeColor}">${volSignal}</div>
                            <div class="mt-2 text-xs text-gray-500">
                                Curr: ${volCurrent.toLocaleString()} | Avg: ${volAvg.toLocaleString()}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signal Indicators -->
                    ${renderSignalIndicators(analysis.signals)}
                </div>
            `;
        }

        // Render signal indicators
        function renderSignalIndicators(signals) {
            if (!signals || (!signals.buy && !signals.sell)) {
                return `
                    <div class="border-t border-gray-700 pt-4">
                        <div class="text-center text-gray-500 text-sm">No active signals</div>
                    </div>
                `;
            }
            
            let html = '<div class="border-t border-gray-700 pt-4 space-y-3">';
            
            if (signals.buy) {
                const confidence = toNum(signals.buy.confidence, 0);
                const entry = toNum(signals.buy.entry, 0);
                const signalCount = toNum(signals.buy.signal_count, 0);
                const totalConditions = toNum(signals.buy.total_conditions, 5);
                const signalList = signals.buy.signals || [];
                const isStrongSignal = signals.buy.action === 'STRONG_BUY';
                const alert = signals.buy.alert || '';
                
                // Greeks data if available
                const greeks = signals.buy.greeks || {};
                const gamma = toNum(greeks.gamma, 0);
                const delta = toNum(greeks.delta, 0);
                const iv = toNum(greeks.iv, 0);
                
                // Additional metrics
                const ofiValue = toNum(signals.buy.ofi, 0);
                const volumeRatio = toNum(signals.buy.volume_ratio, 0);
                
                html += `
                    <div class="bg-green-900 bg-opacity-30 border-2 ${isStrongSignal ? 'border-green-400' : 'border-green-600'} rounded-lg p-4 ${isStrongSignal ? 'signal-buy' : ''}">
                        ${alert ? `<div class="text-yellow-400 font-bold text-center mb-2">${alert}</div>` : ''}
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-green-400 font-bold text-lg">ðŸŸ¢ ${isStrongSignal ? 'STRONG BUY SIGNAL' : 'BUY SIGNAL'}</div>
                            <div class="text-green-400 text-xl font-bold">${(confidence * 100).toFixed(0)}%</div>
                        </div>
                        <div class="text-sm text-gray-300 mb-2">
                            Entry: â‚¹${entry.toFixed(2)} | ${signalCount}/${totalConditions} Conditions Met
                        </div>
                        ${isStrongSignal && (gamma > 0 || delta > 0 || iv > 0) ? `
                        <div class="grid grid-cols-3 gap-2 mb-2 p-2 bg-gray-900 bg-opacity-50 rounded">
                            <div class="text-center">
                                <div class="text-xs text-gray-400">Gamma</div>
                                <div class="text-sm font-bold ${gamma > 0.001 ? 'text-yellow-400' : 'text-gray-300'}">${gamma.toFixed(4)}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-400">Delta</div>
                                <div class="text-sm font-bold ${Math.abs(delta) > 0.6 ? 'text-yellow-400' : 'text-gray-300'}">${delta.toFixed(3)}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-400">IV</div>
                                <div class="text-sm font-bold ${iv > 0.2 ? 'text-yellow-400' : 'text-gray-300'}">${(iv * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                        ` : ''}
                        ${ofiValue > 0 || volumeRatio > 0 ? `
                        <div class="grid grid-cols-2 gap-2 mb-2 p-2 bg-gray-900 bg-opacity-50 rounded">
                            <div>
                                <div class="text-xs text-gray-400">OFI</div>
                                <div class="text-sm font-bold ${ofiValue > 0.6 ? 'text-green-400' : 'text-gray-300'}">${ofiValue.toFixed(3)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">Volume</div>
                                <div class="text-sm font-bold ${volumeRatio >= 3 ? 'text-red-400' : 'text-gray-300'}">${volumeRatio.toFixed(1)}x</div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="space-y-1 max-h-32 overflow-y-auto">
                            ${signalList.map(s => `<div class="text-xs text-green-300">âœ“ ${s}</div>`).join('') || 
                              '<div class="text-xs text-gray-500">No signals available</div>'}
                        </div>
                    </div>
                `;
            }
            
            if (signals.sell) {
                const exit = toNum(signals.sell.exit, 0);
                const signalCount = toNum(signals.sell.signal_count, 0);
                const reason = signals.sell.reason || 'Unknown';
                const signalList = signals.sell.signals || [];
                
                html += `
                    <div class="bg-red-900 bg-opacity-30 border border-red-600 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-red-400 font-bold text-lg">ðŸ”´ SELL SIGNAL</div>
                            <div class="text-red-400 text-sm">${signalCount}/5</div>
                        </div>
                        <div class="text-sm text-gray-300 mb-2">
                            Exit: â‚¹${exit.toFixed(2)} | ${reason}
                        </div>
                        <div class="space-y-1">
                            ${signalList.slice(0, 3).map(s => `<div class="text-xs text-red-300">âœ“ ${s}</div>`).join('') || 
                              '<div class="text-xs text-gray-500">No signals available</div>'}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Render history
        function renderHistory() {
            const container = document.getElementById('signal-history');
            
            if (signalHistory.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No signals yet</div>';
                return;
            }
            
            container.innerHTML = signalHistory.map(signal => {
                const isBuy = signal.action === 'BUY' || signal.action === 'STRONG_BUY';
                const isStrongSignal = signal.action === 'STRONG_BUY';
                const bgColor = isBuy ? (isStrongSignal ? 'bg-green-900 bg-opacity-30 border-green-400' : 'bg-green-900 bg-opacity-20 border-green-600') : 'bg-red-900 bg-opacity-20 border-red-600';
                const textColor = isBuy ? 'text-green-400' : 'text-red-400';
                const symbol = (signal.symbol || 'Unknown').split('|')[1] || signal.symbol;
                const signalList = signal.signals || [];
                
                // Additional data for strong signals
                const greeks = signal.greeks || {};
                const gamma = toNum(greeks.gamma, 0);
                const delta = toNum(greeks.delta, 0);
                const iv = toNum(greeks.iv, 0);
                const ofiValue = toNum(signal.ofi, 0);
                const volumeRatio = toNum(signal.volume_ratio, 0);
                const totalConditions = toNum(signal.total_conditions, 5);
                const signalCount = toNum(signal.signal_count, 0);
                
                return `
                    <div class="border-2 ${bgColor} rounded-lg p-4 mb-3">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="${textColor} font-bold text-lg">
                                    ${isBuy ? (isStrongSignal ? 'ðŸ”¥ STRONG BUY' : 'ðŸŸ¢ BUY') : 'ðŸ”´ SELL'} - ${symbol}
                                </div>
                                <div class="text-gray-300 text-sm mt-1">
                                    ${isBuy ?
                                        `Entry: â‚¹${toNum(signal.entry, 0).toFixed(2)} | ${signalCount}/${totalConditions} conditions | Confidence: ${(toNum(signal.confidence, 0) * 100).toFixed(0)}%` :
                                        `Exit: â‚¹${toNum(signal.exit, 0).toFixed(2)} | ${signal.reason || 'Unknown'}`
                                    }
                                </div>
                                ${isStrongSignal && (gamma > 0 || delta > 0 || iv > 0) ? `
                                <div class="mt-2 grid grid-cols-5 gap-2 text-xs">
                                    <div class="bg-gray-900 bg-opacity-50 rounded px-2 py-1">
                                        <span class="text-gray-400">Î“:</span> 
                                        <span class="font-mono ${gamma > 0.001 ? 'text-yellow-400' : 'text-gray-300'}">${gamma.toFixed(4)}</span>
                                    </div>
                                    <div class="bg-gray-900 bg-opacity-50 rounded px-2 py-1">
                                        <span class="text-gray-400">Î”:</span> 
                                        <span class="font-mono ${Math.abs(delta) > 0.6 ? 'text-yellow-400' : 'text-gray-300'}">${delta.toFixed(3)}</span>
                                    </div>
                                    <div class="bg-gray-900 bg-opacity-50 rounded px-2 py-1">
                                        <span class="text-gray-400">IV:</span> 
                                        <span class="font-mono ${iv > 0.2 ? 'text-yellow-400' : 'text-gray-300'}">${(iv * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="bg-gray-900 bg-opacity-50 rounded px-2 py-1">
                                        <span class="text-gray-400">OFI:</span> 
                                        <span class="font-mono ${ofiValue > 0.6 ? 'text-green-400' : 'text-gray-300'}">${ofiValue.toFixed(3)}</span>
                                    </div>
                                    <div class="bg-gray-900 bg-opacity-50 rounded px-2 py-1">
                                        <span class="text-gray-400">Vol:</span> 
                                        <span class="font-mono ${volumeRatio >= 3 ? 'text-red-400' : 'text-gray-300'}">${volumeRatio.toFixed(1)}x</span>
                                    </div>
                                </div>
                                ` : ''}
                                <div class="mt-2 space-y-1">
                                    ${signalList.slice(0, 4).map(s => 
                                        `<div class="text-xs text-gray-400">â€¢ ${s}</div>`
                                    ).join('') || '<div class="text-xs text-gray-500">No signals available</div>'}
                                    ${signalList.length > 4 ? `<div class="text-xs text-gray-500">+${signalList.length - 4} more signals...</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-500 ml-4">${signal.time || 'Unknown'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear history
        function clearHistory() {
            signalHistory = [];
            renderHistory();
        }

        // Update connection status
        function updateStatus(status) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            if (status === 'connected') {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                text.textContent = 'Disconnected';
            }
        }

        // Initialize
        initSSE();
        
        // Periodic refresh
        setInterval(async () => {
            try {
                const response = await fetch('/api/signals');
                const data = await response.json();
                if (data.analyses) {
                    Object.entries(data.analyses).forEach(([symbol, analysis]) => {
                        instrumentData.set(symbol, analysis);
                    });
                    renderInstruments();
                }
            } catch (error) {
                console.error('Refresh error:', error);
            }
        }, 2000);
    </script>
</body>
</html>