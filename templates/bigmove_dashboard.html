<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Move Detection Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
        }
        .alert-critical { animation: pulse-critical 2s infinite; }
        .alert-warning { animation: pulse-warning 2s infinite; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .score-gauge {
            background: conic-gradient(
                from 0deg,
                #10b981 0deg,
                #10b981 var(--score-deg),
                #1f2937 var(--score-deg),
                #1f2937 360deg
            );
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">ðŸŽ¯ Big Move Detection Dashboard</h1>
                    <p class="text-purple-200 mt-1">Real-time Market Analysis & Scoring</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span id="status-text" class="text-sm">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Alert Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-red-900 bg-opacity-30 border border-red-600 rounded-lg p-6">
                <div class="text-red-400 text-sm font-semibold mb-2">CRITICAL ALERTS</div>
                <div id="critical-count" class="text-4xl font-bold text-red-500">0</div>
            </div>
            
            <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-6">
                <div class="text-yellow-400 text-sm font-semibold mb-2">WARNINGS</div>
                <div id="warning-count" class="text-4xl font-bold text-yellow-500">0</div>
            </div>
            
            <div class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-6">
                <div class="text-blue-400 text-sm font-semibold mb-2">WATCH LIST</div>
                <div id="watch-count" class="text-4xl font-bold text-blue-500">0</div>
            </div>
            
            <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-6">
                <div class="text-green-400 text-sm font-semibold mb-2">NORMAL</div>
                <div id="normal-count" class="text-4xl font-bold text-green-500">0</div>
            </div>
        </div>

        <!-- Analysis Cards -->
        <div id="analysis-cards" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Cards will be inserted here -->
        </div>

        <!-- Active Signals -->
        <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700 mb-8">
            <div class="px-6 py-4 border-b border-gray-700">
                <h2 class="text-xl font-bold">ðŸš¨ Active Signals</h2>
            </div>
            <div id="active-signals" class="p-6">
                <div class="text-gray-500">No active signals</div>
            </div>
        </div>

        <!-- Metrics Table -->
        <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700">
                <h2 class="text-xl font-bold">ðŸ“Š Detailed Metrics</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Symbol</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Score</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">LTP</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Vol Ratio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">OB Ratio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Price Range</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Gamma</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Delta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">IV</th>
                        </tr>
                    </thead>
                    <tbody id="metrics-table" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="9" class="px-6 py-4 text-center text-gray-500">Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let eventSource = null;
        let analysisData = new Map();

        // Initialize SSE
        function initSSE() {
            eventSource = new EventSource('/stream');
            
            eventSource.onopen = () => {
                updateStatus('connected');
                console.log('âœ… Connected to Big Move Detector');
            };
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'live_feed' && data.feeds) {
                        processFeedData(data.feeds);
                    }
                } catch (error) {
                    console.error('Parse error:', error);
                }
            };
            
            eventSource.onerror = () => {
                updateStatus('disconnected');
                setTimeout(initSSE, 5000);
            };
        }

        // Process feed data
        async function processFeedData(feeds) {
            // Fetch analysis from server
            try {
                const response = await fetch('/api/analysis');
                const result = await response.json();
                
                if (result.results) {
                    result.results.forEach(analysis => {
                        analysisData.set(analysis.symbol, analysis);
                    });
                    renderDashboard();
                }
            } catch (error) {
                console.error('Analysis fetch error:', error);
            }
        }

        // Render dashboard
        function renderDashboard() {
            const analyses = Array.from(analysisData.values());
            
            // Update alert counts
            const counts = {
                CRITICAL: 0,
                WARNING: 0,
                WATCH: 0,
                NORMAL: 0
            };
            
            analyses.forEach(a => counts[a.alertLevel]++);
            
            document.getElementById('critical-count').textContent = counts.CRITICAL;
            document.getElementById('warning-count').textContent = counts.WARNING;
            document.getElementById('watch-count').textContent = counts.WATCH;
            document.getElementById('normal-count').textContent = counts.NORMAL;
            
            // Render analysis cards
            renderAnalysisCards(analyses);
            
            // Render signals
            renderSignals(analyses);
            
            // Render metrics table
            renderMetricsTable(analyses);
        }

        // Render analysis cards
        function renderAnalysisCards(analyses) {
            const container = document.getElementById('analysis-cards');
            
            // Sort by score descending
            analyses.sort((a, b) => b.score - a.score);
            
            container.innerHTML = analyses.map(analysis => {
                const alertColors = {
                    CRITICAL: { bg: 'bg-red-900', border: 'border-red-600', text: 'text-red-400', alert: 'alert-critical' },
                    WARNING: { bg: 'bg-yellow-900', border: 'border-yellow-600', text: 'text-yellow-400', alert: 'alert-warning' },
                    WATCH: { bg: 'bg-blue-900', border: 'border-blue-600', text: 'text-blue-400', alert: '' },
                    NORMAL: { bg: 'bg-gray-800', border: 'border-gray-600', text: 'text-gray-400', alert: '' }
                };
                
                const colors = alertColors[analysis.alertLevel];
                const scoreDeg = (analysis.score / 100) * 360;
                
                return `
                    <div class="${colors.bg} bg-opacity-40 border ${colors.border} rounded-lg p-6 shadow-xl ${colors.alert}">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-xl font-bold">${analysis.symbol.split('|')[1]}</h3>
                                <p class="text-gray-400 text-sm">${analysis.symbol}</p>
                            </div>
                            <div class="text-right">
                                <div class="${colors.text} text-2xl font-bold">${analysis.alertLevel}</div>
                            </div>
                        </div>
                        
                        <!-- Score Gauge -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Big Move Score</span>
                                <span class="text-2xl font-bold ${colors.text}">${analysis.score}/100</span>
                            </div>
                            <div class="w-full h-4 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full ${colors.bg} transition-all duration-500" 
                                     style="width: ${analysis.score}%"></div>
                            </div>
                        </div>
                        
                        <!-- Key Metrics Grid -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-900 bg-opacity-50 rounded p-3">
                                <div class="text-xs text-gray-400">LTP</div>
                                <div class="text-lg font-bold">â‚¹${analysis.metrics.ltp}</div>
                            </div>
                            <div class="bg-gray-900 bg-opacity-50 rounded p-3">
                                <div class="text-xs text-gray-400">Volume Ratio</div>
                                <div class="text-lg font-bold ${analysis.metrics.volumeRatio > 2 ? 'text-red-400' : 'text-gray-300'}">
                                    ${analysis.metrics.volumeRatio.toFixed(2)}x
                                </div>
                            </div>
                            <div class="bg-gray-900 bg-opacity-50 rounded p-3">
                                <div class="text-xs text-gray-400">Price Range</div>
                                <div class="text-lg font-bold ${analysis.metrics.priceRange > 1 ? 'text-red-400' : 'text-gray-300'}">
                                    ${analysis.metrics.priceRange.toFixed(2)}%
                                </div>
                            </div>
                            <div class="bg-gray-900 bg-opacity-50 rounded p-3">
                                <div class="text-xs text-gray-400">OB Ratio</div>
                                <div class="text-lg font-bold">${analysis.metrics.obRatio.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <!-- Greeks -->
                        <div class="border-t border-gray-700 pt-4">
                            <div class="text-xs text-gray-400 mb-3">Option Greeks (Score: ${analysis.greeksScore}/15)</div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div>
                                    <span class="text-gray-400">Î“:</span>
                                    <span class="font-mono ${analysis.metrics.gamma > 0.001 ? 'text-yellow-400' : 'text-gray-300'}">
                                        ${analysis.metrics.gamma.toFixed(4)}
                                    </span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Î”:</span>
                                    <span class="font-mono ${Math.abs(analysis.metrics.delta) > 0.7 ? 'text-yellow-400' : 'text-gray-300'}">
                                        ${analysis.metrics.delta.toFixed(3)}
                                    </span>
                                </div>
                                <div>
                                    <span class="text-gray-400">IV:</span>
                                    <span class="font-mono ${analysis.metrics.iv > 0.25 ? 'text-yellow-400' : 'text-gray-300'}">
                                        ${(analysis.metrics.iv * 100).toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Signals Preview -->
                        ${analysis.signals.length > 0 ? `
                            <div class="mt-4 pt-4 border-t border-gray-700">
                                <div class="text-xs text-gray-400 mb-2">${analysis.signals.length} Active Signal(s)</div>
                                <div class="space-y-1">
                                    ${analysis.signals.slice(0, 2).map(signal => `
                                        <div class="text-xs ${signal.type === 'CRITICAL' ? 'text-red-400' : signal.type === 'WARNING' ? 'text-yellow-400' : 'text-blue-400'}">
                                            â€¢ ${signal.title}
                                        </div>
                                    `).join('')}
                                    ${analysis.signals.length > 2 ? `<div class="text-xs text-gray-500">+${analysis.signals.length - 2} more...</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Render active signals
        function renderSignals(analyses) {
            const container = document.getElementById('active-signals');
            const allSignals = [];
            
            analyses.forEach(analysis => {
                analysis.signals.forEach(signal => {
                    allSignals.push({
                        symbol: analysis.symbol,
                        ...signal
                    });
                });
            });
            
            if (allSignals.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No active signals</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${allSignals.map(signal => {
                        const colors = {
                            CRITICAL: 'bg-red-900 bg-opacity-30 border-red-600 text-red-400',
                            WARNING: 'bg-yellow-900 bg-opacity-30 border-yellow-600 text-yellow-400',
                            INFO: 'bg-blue-900 bg-opacity-30 border-blue-600 text-blue-400'
                        };
                        
                        return `
                            <div class="border ${colors[signal.type]} rounded-lg p-4">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="text-xs font-semibold">${signal.type}</div>
                                    <div class="text-xs text-gray-400">${signal.symbol.split('|')[1]}</div>
                                </div>
                                <div class="font-bold mb-1">${signal.title}</div>
                                <div class="text-sm text-gray-300">${signal.message}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Render metrics table
        function renderMetricsTable(analyses) {
            const tbody = document.getElementById('metrics-table');
            
            tbody.innerHTML = analyses.map(analysis => {
                const alertColors = {
                    CRITICAL: 'bg-red-900 bg-opacity-20',
                    WARNING: 'bg-yellow-900 bg-opacity-20',
                    WATCH: 'bg-blue-900 bg-opacity-20',
                    NORMAL: ''
                };
                
                return `
                    <tr class="${alertColors[analysis.alertLevel]}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium">${analysis.symbol.split('|')[1]}</div>
                            <div class="text-xs text-gray-500">${analysis.symbol}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-sm font-bold rounded-full ${
                                analysis.score >= 75 ? 'bg-red-600' :
                                analysis.score >= 55 ? 'bg-yellow-600' :
                                analysis.score >= 35 ? 'bg-blue-600' : 'bg-green-600'
                            }">${analysis.score}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono">â‚¹${analysis.metrics.ltp}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${analysis.metrics.volumeRatio > 2 ? 'text-red-400 font-bold' : ''}">
                            ${analysis.metrics.volumeRatio.toFixed(2)}x
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap ${analysis.metrics.obRatio > 3 ? 'text-green-400' : analysis.metrics.obRatio < 0.33 ? 'text-red-400' : ''}">
                            ${analysis.metrics.obRatio.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap ${analysis.metrics.priceRange > 1 ? 'text-red-400 font-bold' : ''}">
                            ${analysis.metrics.priceRange.toFixed(2)}%
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs ${analysis.metrics.gamma > 0.001 ? 'text-yellow-400' : ''}">
                            ${analysis.metrics.gamma.toFixed(4)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs ${Math.abs(analysis.metrics.delta) > 0.7 ? 'text-yellow-400' : ''}">
                            ${analysis.metrics.delta.toFixed(3)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs ${analysis.metrics.iv > 0.25 ? 'text-yellow-400' : ''}">
                            ${(analysis.metrics.iv * 100).toFixed(1)}%
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update connection status
        function updateStatus(status) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            if (status === 'connected') {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                text.textContent = 'Disconnected';
            }
        }

        // Initialize
        initSSE();
    </script>
</body>
</html>